#!/usr/bin/python3

# Copyright (C) 2013 Canonical Ltd.
# Author: St√©phane Graber <stgraber@ubuntu.com>

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 3 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

import os
import sys
sys.path.insert(0, os.path.join(sys.path[0], os.pardir, "lib"))

from phablet.diff import ImageDiff
from phablet.tools import mount, umount

import argparse
import tempfile

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description="squashfs diff generator")

    parser.add_argument("source", metavar="SOURCE-SQUASHFS")
    parser.add_argument("target", metavar="TARGET-SQUASHFS")
    parser.add_argument("output", metavar="OUTPUT-PREFIX", nargs="?",
                        help="Output a squashfs with the diff along with "
                             "a file listing all removals.")

    args = parser.parse_args()

    # Some checks
    if not os.path.exists(args.source):
        parser.error("Source squashfs '%s' doesn't exist." % args.source)

    if not os.path.exists(args.target):
        parser.error("Target squashfs '%s' doesn't exist." % args.target)

    # Mount the two squashfs
    source = tempfile.mkdtemp()
    target = tempfile.mkdtemp()
    mount(args.source, source, ('ro', 'loop'))
    mount(args.target, target, ('ro', 'loop'))

    imagediff = ImageDiff(source, target)

    # Do something with the changes
    if not hasattr(args, "output") or not args.output:
        imagediff.print_changes()
    else:
        imagediff.generate_removal_list("%s.removals" % args.output)
        imagediff.generate_diff_squashfs("%s.squashfs" % args.output)

    # Cleanup
    umount(source)
    umount(target)
    os.rmdir(source)
    os.rmdir(target)
